<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>四色定理小游戏</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #ec4899;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
            --light-bg: #f8fafc;
            --white: #ffffff;
            --dark: #1e293b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: var(--dark);
        }
        
        .game-container {
            background-color: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            padding: 30px;
            width: 100%;
            max-width: 900px;
            margin-top: 20px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 2px;
        }
        
        .instructions {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary-color);
        }
        
        .instructions p {
            margin-bottom: 10px;
            line-height: 1.6;
            color: var(--dark);
        }
        
        .instructions p:last-child {
            margin-bottom: 0;
        }
        
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .level-selector, .optimization-selector {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .level-btn, .optimization-btn {
            padding: 10px 20px;
            font-size: 15px;
            font-weight: 500;
            border: none;
            border-radius: 10px;
            background-color: var(--light-bg);
            color: var(--dark);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        .level-btn::before, .optimization-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }
        
        .level-btn:hover, .optimization-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .level-btn.active, .optimization-btn.active {
            color: var(--white);
            background-color: var(--primary-color);
        }
        
        .level-btn.active::before, .optimization-btn.active::before {
            opacity: 1;
        }
        
        .level-btn span, .optimization-btn span {
            position: relative;
            z-index: 1;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 20px;
            gap: 20px;
        }
        
        .timer, .moves {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .timer::before, .moves::before {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .timer::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z'/%3E%3C/svg%3E");
        }
        
        .moves::before {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'%3E%3Cpath d='M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z'/%3E%3C/svg%3E");
        }
        
        .color-palette {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            padding: 15px;
            background-color: var(--light-bg);
            border-radius: 15px;
            box-shadow: var(--shadow);
        }
        
        .color-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            border: 4px solid transparent;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .color-option::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            background-color: var(--white);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .color-option:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }
        
        .color-option.selected {
            border: 4px solid var(--dark);
            transform: scale(1.15);
        }
        
        .color-option.selected::after {
            opacity: 1;
        }
        
        #gameCanvas {
            border: none;
            border-radius: 15px;
            background-color: var(--white);
            box-shadow: var(--shadow-lg);
            margin-bottom: 25px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .controls button {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .controls button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            transition: opacity 0.3s ease;
        }
        
        .controls button span {
            position: relative;
            z-index: 1;
        }
        
        #resetBtn {
            background-color: var(--error-color);
            color: var(--white);
        }
        
        #resetBtn:hover {
            background-color: #dc2626;
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        #checkBtn {
            background-color: var(--success-color);
            color: var(--white);
        }
        
        #checkBtn:hover {
            background-color: #059669;
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        #hintBtn {
            background-color: var(--info-color);
            color: var(--white);
        }
        
        #hintBtn:hover {
            background-color: #2563eb;
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .message {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            width: 100%;
            display: none;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border-left: 5px solid var(--success-color);
        }
        
        .error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            border-left: 5px solid var(--error-color);
        }
        
        .info {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--info-color);
            border-left: 5px solid var(--info-color);
        }
        
        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .game-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .color-palette {
                gap: 15px;
            }
            
            .color-option {
                width: 50px;
                height: 50px;
            }
            
            #gameCanvas {
                max-width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>四色定理小游戏</h1>
        
        <div class="instructions">
            <p>四色定理：任何平面地图都可以用最多四种颜色进行着色，使得相邻区域颜色不同。</p>
            <p>游戏目标：选择下方的颜色，点击图形区域进行上色，确保相邻区域颜色不同，直到所有区域都填满颜色。</p>
        </div>
        
        <div class="game-controls">
            <div class="level-selector">
                <button class="level-btn active" data-level="1"><span>关卡 1</span></button>
                <button class="level-btn" data-level="2"><span>关卡 2</span></button>
                <button class="level-btn" data-level="3"><span>关卡 3</span></button>
            </div>
            
            <div class="optimization-selector">
                <button class="optimization-btn active" data-optimization="none"><span>普通模式</span></button>
                <button class="optimization-btn" data-optimization="red"><span>红色最少</span></button>
                <button class="optimization-btn" data-optimization="green"><span>绿色最少</span></button>
                <button class="optimization-btn" data-optimization="blue"><span>蓝色最少</span></button>
                <button class="optimization-btn" data-optimization="yellow"><span>黄色最少</span></button>
            </div>
        </div>
        
        <div class="game-info">
            <div class="timer">时间: <span id="timeDisplay">00:00</span></div>
            <div class="moves">步数: <span id="movesDisplay">0</span></div>
        </div>
        
        <div class="color-palette">
            <div class="color-option selected" data-color="#FF5252" style="background-color: #FF5252;"></div>
            <div class="color-option" data-color="#4CAF50" style="background-color: #4CAF50;"></div>
            <div class="color-option" data-color="#2196F3" style="background-color: #2196F3;"></div>
            <div class="color-option" data-color="#FFC107" style="background-color: #FFC107;"></div>
        </div>
        
        <canvas id="gameCanvas" width="600" height="500"></canvas>
        
        <div class="controls">
            <button id="resetBtn"><span>重置游戏</span></button>
            <button id="checkBtn"><span>检查结果</span></button>
            <button id="hintBtn"><span>提示</span></button>
        </div>
        
        <div id="message" class="message"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const colorOptions = document.querySelectorAll('.color-option');
            const resetBtn = document.getElementById('resetBtn');
            const checkBtn = document.getElementById('checkBtn');
            const hintBtn = document.getElementById('hintBtn');
            const messageDiv = document.getElementById('message');
            const levelBtns = document.querySelectorAll('.level-btn');
            const optimizationBtns = document.querySelectorAll('.optimization-btn');
            const timeDisplay = document.getElementById('timeDisplay');
            const movesDisplay = document.getElementById('movesDisplay');
            
            let selectedColor = '#FF5252';
            let currentLevel = 1;
            let currentOptimization = 'none';
            let moves = 0;
            let startTime = null;
            let timerInterval = null;
            let gameCompleted = false;
            
            // 关卡配置
            const levels = {
                1: {
                    name: "简单",
                    regions: [
                        {
                            id: 1,
                            points: [[100, 100], [200, 80], [250, 150], [220, 220], [150, 200], [80, 180]],
                            neighbors: [2, 3, 4],
                            color: null
                        },
                        {
                            id: 2,
                            points: [[200, 80], [300, 100], [350, 180], [280, 220], [250, 150]],
                            neighbors: [1, 3, 5],
                            color: null
                        },
                        {
                            id: 3,
                            points: [[150, 200], [220, 220], [200, 300], [120, 280], [80, 180]],
                            neighbors: [1, 2, 4, 6],
                            color: null
                        },
                        {
                            id: 4,
                            points: [[80, 180], [120, 280], [100, 350], [50, 300], [30, 220]],
                            neighbors: [1, 3, 6],
                            color: null
                        },
                        {
                            id: 5,
                            points: [[280, 220], [350, 180], [400, 250], [380, 320], [300, 300], [200, 300]],
                            neighbors: [2, 3, 6, 7],
                            color: null
                        },
                        {
                            id: 6,
                            points: [[100, 350], [200, 300], [250, 380], [150, 400], [50, 300]],
                            neighbors: [3, 4, 5, 7],
                            color: null
                        },
                        {
                            id: 7,
                            points: [[200, 300], [300, 300], [350, 380], [280, 450], [200, 430], [150, 400], [250, 380]],
                            neighbors: [5, 6],
                            color: null
                        }
                    ]
                },
                2: {
                    name: "中等",
                    regions: [
                        {
                            id: 1,
                            points: [[100, 80], [180, 60], [220, 120], [200, 180], [150, 200], [80, 160]],
                            neighbors: [2, 3, 4],
                            color: null
                        },
                        {
                            id: 2,
                            points: [[180, 60], [280, 70], [320, 140], [280, 200], [220, 120]],
                            neighbors: [1, 3, 5],
                            color: null
                        },
                        {
                            id: 3,
                            points: [[150, 200], [200, 180], [220, 120], [280, 200], [250, 260], [180, 280], [120, 240]],
                            neighbors: [1, 2, 4, 5, 6],
                            color: null
                        },
                        {
                            id: 4,
                            points: [[80, 160], [150, 200], [120, 240], [100, 300], [50, 280], [30, 200]],
                            neighbors: [1, 3, 6],
                            color: null
                        },
                        {
                            id: 5,
                            points: [[280, 200], [320, 140], [380, 180], [400, 260], [350, 320], [280, 280], [250, 260]],
                            neighbors: [2, 3, 6, 7],
                            color: null
                        },
                        {
                            id: 6,
                            points: [[120, 240], [180, 280], [250, 260], [280, 280], [250, 340], [180, 360], [100, 320], [100, 300]],
                            neighbors: [3, 4, 5, 7, 8],
                            color: null
                        },
                        {
                            id: 7,
                            points: [[280, 280], [350, 320], [380, 400], [320, 440], [250, 400], [250, 340]],
                            neighbors: [5, 6, 8],
                            color: null
                        },
                        {
                            id: 8,
                            points: [[100, 320], [180, 360], [250, 340], [250, 400], [200, 440], [120, 420], [80, 360]],
                            neighbors: [6, 7],
                            color: null
                        }
                    ]
                },
                3: {
                    name: "困难",
                    regions: [
                        {
                            id: 1,
                            points: [[80, 60], [160, 40], [200, 100], [180, 160], [130, 180], [60, 140]],
                            neighbors: [2, 3, 4],
                            color: null
                        },
                        {
                            id: 2,
                            points: [[160, 40], [260, 50], [300, 120], [260, 180], [200, 100]],
                            neighbors: [1, 3, 5],
                            color: null
                        },
                        {
                            id: 3,
                            points: [[130, 180], [180, 160], [200, 100], [260, 180], [230, 240], [160, 260], [100, 220]],
                            neighbors: [1, 2, 4, 5, 6],
                            color: null
                        },
                        {
                            id: 4,
                            points: [[60, 140], [130, 180], [100, 220], [80, 280], [30, 260], [10, 180]],
                            neighbors: [1, 3, 6],
                            color: null
                        },
                        {
                            id: 5,
                            points: [[260, 180], [300, 120], [360, 160], [380, 240], [330, 300], [260, 280], [230, 240]],
                            neighbors: [2, 3, 6, 7],
                            color: null
                        },
                        {
                            id: 6,
                            points: [[100, 220], [160, 260], [230, 240], [260, 280], [230, 340], [160, 360], [80, 320], [80, 280]],
                            neighbors: [3, 4, 5, 7, 8],
                            color: null
                        },
                        {
                            id: 7,
                            points: [[260, 280], [330, 300], [360, 380], [300, 420], [230, 380], [230, 340]],
                            neighbors: [5, 6, 8, 9],
                            color: null
                        },
                        {
                            id: 8,
                            points: [[80, 320], [160, 360], [230, 340], [230, 380], [180, 420], [100, 400], [60, 340]],
                            neighbors: [6, 7, 9],
                            color: null
                        },
                        {
                            id: 9,
                            points: [[180, 420], [230, 380], [300, 420], [320, 480], [260, 500], [180, 480], [100, 400]],
                            neighbors: [7, 8],
                            color: null
                        }
                    ]
                }
            };
            
            let regions = [...levels[currentLevel].regions];
            
            // 初始化颜色选择器
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedColor = this.getAttribute('data-color');
                    
                    // 添加选中动画效果
                    this.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 300);
                });
            });
            
            // 初始化关卡选择器
            levelBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (gameCompleted) return;
                    
                    const level = parseInt(this.getAttribute('data-level'));
                    if (level === currentLevel) return;
                    
                    levelBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 添加切换动画效果
                    this.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 300);
                    
                    currentLevel = level;
                    regions = [...levels[currentLevel].regions];
                    resetGame();
                    showMessage(`已切换到${levels[currentLevel].name}难度`, 'info');
                });
            });
            
            // 初始化优化选择器
            optimizationBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    if (gameCompleted) return;
                    
                    const optimization = this.getAttribute('data-optimization');
                    if (optimization === currentOptimization) return;
                    
                    optimizationBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 添加切换动画效果
                    this.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 300);
                    
                    currentOptimization = optimization;
                    showMessage(`已切换到${this.textContent}模式`, 'info');
                });
            });
            
            // 初始化提示按钮
            hintBtn.addEventListener('click', function() {
                if (gameCompleted) return;
                
                // 找到一个未上色的区域
                const uncoloredRegion = regions.find(region => region.color === null);
                if (!uncoloredRegion) {
                    showMessage('所有区域都已上色！', 'info');
                    return;
                }
                
                // 获取相邻区域的颜色
                const neighborColors = new Set();
                uncoloredRegion.neighbors.forEach(neighborId => {
                    const neighbor = regions.find(r => r.id === neighborId);
                    if (neighbor.color) {
                        neighborColors.add(neighbor.color);
                    }
                });
                
                // 找出可用的颜色
                const availableColors = ['#FF5252', '#4CAF50', '#2196F3', '#FFC107']
                    .filter(color => !neighborColors.has(color));
                
                if (availableColors.length > 0) {
                    // 根据最优解设置选择最佳颜色
                    let hintColor;
                    if (currentOptimization === 'none') {
                        // 随机选择一个可用颜色
                        hintColor = availableColors[Math.floor(Math.random() * availableColors.length)];
                    } else {
                        // 计算每种颜色已使用的次数
                        const colorCounts = {
                            '#FF5252': regions.filter(r => r.color === '#FF5252').length,
                            '#4CAF50': regions.filter(r => r.color === '#4CAF50').length,
                            '#2196F3': regions.filter(r => r.color === '#2196F3').length,
                            '#FFC107': regions.filter(r => r.color === '#FFC107').length
                        };
                        
                        const colorMap = {
                            'red': '#FF5252',
                            'green': '#4CAF50',
                            'blue': '#2196F3',
                            'yellow': '#FFC107'
                        };
                        
                        // 找出可用颜色中使用次数最少的
                        hintColor = availableColors.reduce((min, color) => 
                            colorCounts[color] < colorCounts[min] ? color : min, availableColors[0]);
                    }
                    
                    // 高亮显示建议的颜色
                    colorOptions.forEach(opt => {
                        if (opt.getAttribute('data-color') === hintColor) {
                            opt.style.transform = 'scale(1.2)';
                            opt.style.boxShadow = '0 0 15px rgba(0,0,0,0.7)';
                            
                            setTimeout(() => {
                                opt.style.transform = '';
                                opt.style.boxShadow = '';
                            }, 2000);
                        }
                    });
                    
                    // 高亮显示建议上色的区域
                    drawRegions();
                    ctx.save();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 4;
                    ctx.setLineDash([5, 5]);
                    
                    ctx.beginPath();
                    ctx.moveTo(uncoloredRegion.points[0][0], uncoloredRegion.points[0][1]);
                    for (let i = 1; i < uncoloredRegion.points.length; i++) {
                        ctx.lineTo(uncoloredRegion.points[i][0], uncoloredRegion.points[i][1]);
                    }
                    ctx.closePath();
                    ctx.stroke();
                    ctx.restore();
                    
                    showMessage(`提示：尝试用${getColorName(hintColor)}给区域 ${uncoloredRegion.id} 上色`, 'info');
                } else {
                    showMessage('无法找到合适的颜色，请检查相邻区域的颜色', 'error');
                }
            });
            
            // 获取颜色名称
            function getColorName(color) {
                const colorNames = {
                    'red': '红',
                    'green': '绿',
                    'blue': '蓝',
                    'yellow': '黄',
                    '#FF5252': '红',
                    '#4CAF50': '绿',
                    '#2196F3': '蓝',
                    '#FFC107': '黄'
                };
                return colorNames[color] || color;
            }
            
            // 开始计时
            function startTimer() {
                if (timerInterval) clearInterval(timerInterval);
                
                startTime = Date.now();
                timerInterval = setInterval(updateTimer, 1000);
            }
            
            // 更新计时器
            function updateTimer() {
                if (!startTime) return;
                
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                
                timeDisplay.textContent = `${minutes}:${seconds}`;
            }
            
            // 停止计时
            function stopTimer() {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
            }
            
            // 更新步数
            function updateMoves() {
                moves++;
                movesDisplay.textContent = moves;
            }
            
            // 绘制多边形区域
            function drawRegions() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                regions.forEach(region => {
                    ctx.beginPath();
                    ctx.moveTo(region.points[0][0], region.points[0][1]);
                    
                    for (let i = 1; i < region.points.length; i++) {
                        ctx.lineTo(region.points[i][0], region.points[i][1]);
                    }
                    
                    ctx.closePath();
                    
                    // 填充颜色
                    if (region.color) {
                        ctx.fillStyle = region.color;
                        ctx.fill();
                    }
                    
                    // 绘制边框
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // 绘制区域ID
                    const centerX = region.points.reduce((sum, point) => sum + point[0], 0) / region.points.length;
                    const centerY = region.points.reduce((sum, point) => sum + point[1], 0) / region.points.length;
                    
                    ctx.fillStyle = region.color ? getContrastColor(region.color) : '#333';
                    ctx.font = 'bold 16px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(region.id.toString(), centerX, centerY);
                });
            }
            
            // 获取对比色（用于文字显示）
            function getContrastColor(hexColor) {
                const r = parseInt(hexColor.substr(1, 2), 16);
                const g = parseInt(hexColor.substr(3, 2), 16);
                const b = parseInt(hexColor.substr(5, 2), 16);
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                return brightness > 128 ? '#000' : '#fff';
            }
            
            // 检查点是否在多边形内（提高灵敏度）
            function isPointInPolygon(point, polygon) {
                const x = point[0];
                const y = point[1];
                let inside = false;
                
                // 增加容差范围，提高灵敏度
                const tolerance = 5;
                
                for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                    const xi = polygon[i][0];
                    const yi = polygon[i][1];
                    const xj = polygon[j][0];
                    const yj = polygon[j][1];
                    
                    const intersect = ((yi > y) !== (yj > y)) &&
                        (x < (xj - xi) * (y - yi) / (yj - yi) + xi + tolerance);
                    
                    if (intersect) inside = !inside;
                }
                
                return inside;
            }
            
            // 处理画布点击事件
            canvas.addEventListener('click', function(event) {
                if (gameCompleted) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                // 查找点击的区域
                for (let i = regions.length - 1; i >= 0; i--) {
                    if (isPointInPolygon([x, y], regions[i].points)) {
                        // 如果是第一次操作，开始计时
                        if (moves === 0 && !startTime) {
                            startTimer();
                        }
                        
                        // 如果区域已经有颜色且与新颜色相同，则取消上色
                        if (regions[i].color === selectedColor) {
                            regions[i].color = null;
                            showMessage('区域 ' + regions[i].id + ' 的颜色已清除', 'info');
                        } else {
                            // 添加上色动画效果
                            animateRegionColoring(regions[i], selectedColor);
                            regions[i].color = selectedColor;
                            updateMoves();
                            showMessage('区域 ' + regions[i].id + ' 已上色', 'info');
                        }
                        
                        drawRegions();
                        break;
                    }
                }
            });
            
            // 区域上色动画效果
            function animateRegionColoring(region, color) {
                const originalColor = region.color;
                const steps = 10;
                let currentStep = 0;
                
                const animationInterval = setInterval(() => {
                    currentStep++;
                    
                    if (currentStep <= steps) {
                        // 计算当前透明度
                        const alpha = currentStep / steps;
                        
                        // 临时绘制区域
                        drawRegions();
                        
                        ctx.save();
                        ctx.globalAlpha = alpha;
                        ctx.beginPath();
                        ctx.moveTo(region.points[0][0], region.points[0][1]);
                        
                        for (let j = 1; j < region.points.length; j++) {
                            ctx.lineTo(region.points[j][0], region.points[j][1]);
                        }
                        
                        ctx.closePath();
                        ctx.fillStyle = color;
                        ctx.fill();
                        ctx.restore();
                    } else {
                        clearInterval(animationInterval);
                        drawRegions();
                    }
                }, 30);
            }
            
            // 处理画布鼠标移动事件（增加悬停效果）
            canvas.addEventListener('mousemove', function(event) {
                if (gameCompleted) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                // 查找悬停的区域
                let hoveredRegion = null;
                for (let i = regions.length - 1; i >= 0; i--) {
                    if (isPointInPolygon([x, y], regions[i].points)) {
                        hoveredRegion = regions[i];
                        break;
                    }
                }
                
                // 更改鼠标样式
                canvas.style.cursor = hoveredRegion ? 'pointer' : 'default';
                
                // 重绘区域，高亮显示悬停的区域
                drawRegions();
                if (hoveredRegion) {
                    ctx.save();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([5, 3]);
                    
                    ctx.beginPath();
                    ctx.moveTo(hoveredRegion.points[0][0], hoveredRegion.points[0][1]);
                    for (let i = 1; i < hoveredRegion.points.length; i++) {
                        ctx.lineTo(hoveredRegion.points[i][0], hoveredRegion.points[i][1]);
                    }
                    ctx.closePath();
                    ctx.stroke();
                    ctx.restore();
                }
            });
            
            // 重置游戏
            resetBtn.addEventListener('click', function() {
                resetGame();
            });
            
            // 重置游戏函数
            function resetGame() {
                regions.forEach(region => {
                    region.color = null;
                });
                
                moves = 0;
                movesDisplay.textContent = moves;
                stopTimer();
                startTime = null;
                timeDisplay.textContent = '00:00';
                gameCompleted = false;
                
                drawRegions();
                hideMessage();
            }
            
            // 庆祝成功动画效果
            function celebrateSuccess() {
                // 创建彩色粒子效果
                const particles = [];
                const particleCount = 100;
                
                // 初始化粒子
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: canvas.width / 2,
                        y: canvas.height / 2,
                        radius: Math.random() * 5 + 2,
                        color: ['#FF5252', '#4CAF50', '#2196F3', '#FFC107'][Math.floor(Math.random() * 4)],
                        speed: Math.random() * 5 + 2,
                        angle: Math.random() * Math.PI * 2,
                        life: 100
                    });
                }
                
                // 动画函数
                function animateParticles() {
                    drawRegions();
                    
                    let activeParticles = 0;
                    
                    particles.forEach(particle => {
                        if (particle.life > 0) {
                            activeParticles++;
                            
                            // 更新粒子位置
                            particle.x += Math.cos(particle.angle) * particle.speed;
                            particle.y += Math.sin(particle.angle) * particle.speed;
                            particle.life--;
                            
                            // 绘制粒子
                            ctx.save();
                            ctx.globalAlpha = particle.life / 100;
                            ctx.beginPath();
                            ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                            ctx.fillStyle = particle.color;
                            ctx.fill();
                            ctx.restore();
                        }
                    });
                    
                    if (activeParticles > 0) {
                        requestAnimationFrame(animateParticles);
                    } else {
                        drawRegions();
                    }
                }
                
                // 开始动画
                animateParticles();
            }
            
            // 检查结果
            checkBtn.addEventListener('click', function() {
                // 检查是否所有区域都已上色
                const allColored = regions.every(region => region.color !== null);
                
                if (!allColored) {
                    showMessage('请将所有区域都上色！', 'error');
                    return;
                }
                
                // 检查相邻区域颜色是否不同
                let isValid = true;
                for (let i = 0; i < regions.length; i++) {
                    const region = regions[i];
                    for (let j = 0; j < region.neighbors.length; j++) {
                        const neighborId = region.neighbors[j];
                        const neighbor = regions.find(r => r.id === neighborId);
                        
                        if (region.color === neighbor.color) {
                            isValid = false;
                            break;
                        }
                    }
                    if (!isValid) break;
                }
                
                if (isValid) {
                    stopTimer();
                    gameCompleted = true;
                    const time = timeDisplay.textContent;
                    
                    // 检查最优解条件
                    let optimizationResult = '';
                    if (currentOptimization !== 'none') {
                        const colorCounts = {
                            '#FF5252': regions.filter(r => r.color === '#FF5252').length,
                            '#4CAF50': regions.filter(r => r.color === '#4CAF50').length,
                            '#2196F3': regions.filter(r => r.color === '#2196F3').length,
                            '#FFC107': regions.filter(r => r.color === '#FFC107').length
                        };
                        
                        const colorMap = {
                            'red': '#FF5252',
                            'green': '#4CAF50',
                            'blue': '#2196F3',
                            'yellow': '#FFC107'
                        };
                        
                        const targetColor = colorMap[currentOptimization];
                        const minCount = Math.min(...Object.values(colorCounts));
                        
                        if (colorCounts[targetColor] === minCount) {
                            optimizationResult = `，并且成功使${getColorName(targetColor)}色块数最少（${minCount}个）！`;
                        } else {
                            optimizationResult = `，但未使${getColorName(targetColor)}色块数最少。`;
                        }
                    }
                    
                    // 添加庆祝动画效果
                    celebrateSuccess();
                    
                    showMessage(`恭喜！你成功完成了${levels[currentLevel].name}难度挑战！用时：${time}，步数：${moves}${optimizationResult}`, 'success');
                } else {
                    showMessage('有相邻区域颜色相同，请重新上色！', 'error');
                }
            });
            
            // 显示消息
            function showMessage(text, type) {
                messageDiv.textContent = text;
                messageDiv.className = 'message ' + type;
                messageDiv.style.display = 'block';
                
                // 如果是信息消息，3秒后自动隐藏
                if (type === 'info') {
                    setTimeout(hideMessage, 3000);
                }
            }
            
            // 隐藏消息
            function hideMessage() {
                messageDiv.style.display = 'none';
            }
            
            // 初始化游戏
            drawRegions();
        });
    </script>
</body>
</html>
