<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可自定义颜色科学计算器</title>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --danger-color: #ea4335;
            --warning-color: #fbbc05;
            --dark-color: #202124;
            --light-color: #f8f9fa;
            --text-color: #333;
            --border-radius: 16px;
            --button-gap: 12px;
            --display-bg: var(--dark-color);
            --display-text: white;
            --number-btn-bg: white;
            --number-btn-text: var(--text-color);
            --number-btn-border: #e0e0e0;
            --operator-btn-bg: var(--warning-color);
            --operator-btn-text: var(--dark-color);
            --function-btn-bg: var(--primary-color);
            --function-btn-text: white;
            --equals-btn-bg: var(--secondary-color);
            --equals-btn-text: white;
            --clear-btn-bg: var(--danger-color);
            --clear-btn-text: white;
            --symbol-btn-bg: #9b59b6;
            --symbol-btn-text: white;
            --constant-btn-bg: #00bcd4;
            --constant-btn-text: white;
            --body-bg: linear-gradient(135deg, #f6f7f9 0%, #e7e9ee 100%);
            --calculator-bg: white;
            --advanced-panel-bg: #f8f9fa;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Google Sans', Roboto, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--body-bg);
            margin: 0;
            color: var(--text-color);
            padding: 20px;
        }
        
        .calculator-container {
            width: 900px;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .color-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .color-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .color-control label {
            font-size: 0.9em;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .color-control input[type="color"] {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .preset-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            background-color: #f1f1f1;
            transition: all 0.2s;
        }
        
        .preset-btn:hover {
            background-color: #e0e0e0;
        }
        
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .mode-btn {
            padding: 14px 28px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: white;
            color: var(--dark-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid #dfe1e5;
        }
        
        .mode-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        
        .calculator {
            width: 100%;
            background-color: var(--calculator-bg);
            border-radius: var(--border-radius);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.12);
            overflow: hidden;
        }
        
        .display {
            padding: 28px;
            text-align: right;
            background-color: var(--display-bg);
            color: var(--display-text);
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            position: relative;
        }
        
        .display-input {
            font-size: 1.8em;
            margin-bottom: 12px;
            min-height: 1.8em;
            word-wrap: break-word;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .display-result {
            font-size: 3em;
            font-weight: 400;
            min-height: 1.5em;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .buttons-container {
            display: flex;
            flex-wrap: wrap;
        }
        
        .basic-buttons, .advanced-buttons {
            display: grid;
            gap: var(--button-gap);
            padding: 20px;
        }
        
        .basic-buttons {
            grid-template-columns: repeat(5, 1fr);
            flex: 2;
        }
        
        .advanced-buttons {
            grid-template-columns: repeat(3, 1fr);
            flex: 1;
            background-color: var(--advanced-panel-bg);
            border-left: 1px solid #e0e0e0;
        }
        
        button {
            border: none;
            padding: 22px 0;
            font-size: 1.4em;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 12px;
            font-weight: 500;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        button:focus:not(:active)::after {
            animation: ripple 0.6s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
            filter: brightness(1.1);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .number {
            background-color: var(--number-btn-bg);
            color: var(--number-btn-text);
            border: 1px solid var(--number-btn-border);
        }
        
        .operator {
            background-color: var(--operator-btn-bg);
            color: var(--operator-btn-text);
        }
        
        .function {
            background-color: var(--function-btn-bg);
            color: var(--function-btn-text);
        }
        
        .equals {
            background-color: var(--equals-btn-bg);
            color: var(--equals-btn-text);
            grid-column: span 2;
        }
        
        .clear {
            background-color: var(--clear-btn-bg);
            color: var(--clear-btn-text);
        }
        
        .symbol {
            background-color: var(--symbol-btn-bg);
            color: var(--symbol-btn-text);
        }
        
        .constant {
            background-color: var(--constant-btn-bg);
            color: var(--constant-btn-text);
        }
        
        .hidden {
            display: none;
        }
        
        .small-text {
            font-size: 0.7em;
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .buttons-container {
                flex-direction: column;
            }
            
            .advanced-buttons {
                border-left: none;
                border-top: 1px solid #e0e0e0;
            }
            
            .basic-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
            
            button {
                padding: 18px 0;
                font-size: 1.2em;
            }
            
            .color-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="color-controls">
            <div class="color-control">
                <label for="primary-color">主色:</label>
                <input type="color" id="primary-color" value="#4285f4" onchange="updateColor('--primary-color', this.value)">
            </div>
            <div class="color-control">
                <label for="secondary-color">辅助色:</label>
                <input type="color" id="secondary-color" value="#34a853" onchange="updateColor('--secondary-color', this.value)">
            </div>
            <div class="color-control">
                <label for="danger-color">危险色:</label>
                <input type="color" id="danger-color" value="#ea4335" onchange="updateColor('--danger-color', this.value)">
            </div>
            <div class="color-control">
                <label for="warning-color">警告色:</label>
                <input type="color" id="warning-color" value="#fbbc05" onchange="updateColor('--warning-color', this.value)">
            </div>
            <div class="color-control">
                <label for="dark-color">深色:</label>
                <input type="color" id="dark-color" value="#202124" onchange="updateColor('--dark-color', this.value)">
            </div>
            <div class="color-control">
                <label for="display-bg">显示屏背景:</label>
                <input type="color" id="display-bg" value="#202124" onchange="updateColor('--display-bg', this.value)">
            </div>
            <div class="color-control">
                <label for="display-text">显示屏文字:</label>
                <input type="color" id="display-text" value="#ffffff" onchange="updateColor('--display-text', this.value)">
            </div>
            <div class="color-control">
                <label for="calculator-bg">计算器背景:</label>
                <input type="color" id="calculator-bg" value="#ffffff" onchange="updateColor('--calculator-bg', this.value)">
            </div>
            
            <div class="preset-buttons">
                <button class="preset-btn" onclick="applyPreset('default')">默认主题</button>
                <button class="preset-btn" onclick="applyPreset('dark')">暗黑主题</button>
                <button class="preset-btn" onclick="applyPreset('light')">明亮主题</button>
                <button class="preset-btn" onclick="applyPreset('ocean')">海洋主题</button>
                <button class="preset-btn" onclick="applyPreset('forest')">森林主题</button>
            </div>
        </div>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('basic')">标准计算</button>
            <button class="mode-btn" onclick="switchMode('advanced')">科学计算</button>
        </div>
        
        <div class="calculator">
            <div class="display">
                <div class="display-input" id="input"></div>
                <div class="display-result" id="result">0</div>
            </div>
            
            <div class="buttons-container">
                <div class="basic-buttons">
                    <button class="clear" onclick="clearAll()">AC</button>
                    <button class="operator" onclick="backspace()">⌫</button>
                    <button class="operator" onclick="appendToInput('%')">%</button>
                    <button class="operator" onclick="appendToInput('(')">(</button>
                    <button class="operator" onclick="appendToInput(')')">)</button>
                    
                    <button class="number" onclick="appendToInput('7')">7</button>
                    <button class="number" onclick="appendToInput('8')">8</button>
                    <button class="number" onclick="appendToInput('9')">9</button>
                    <button class="operator" onclick="appendToInput('/')">÷</button>
                    <button class="function" onclick="appendToInput('Math.sqrt(')">
                        √
                        <span class="small-text">sqrt</span>
                    </button>
                    
                    <button class="number" onclick="appendToInput('4')">4</button>
                    <button class="number" onclick="appendToInput('5')">5</button>
                    <button class="number" onclick="appendToInput('6')">6</button>
                    <button class="operator" onclick="appendToInput('*')">×</button>
                    <button class="function" onclick="appendToInput('Math.pow(')">
                        x^y
                        <span class="small-text">pow</span>
                    </button>
                    
                    <button class="number" onclick="appendToInput('1')">1</button>
                    <button class="number" onclick="appendToInput('2')">2</button>
                    <button class="number" onclick="appendToInput('3')">3</button>
                    <button class="operator" onclick="appendToInput('-')">-</button>
                    <button class="function" onclick="appendToInput('Math.log10(')">
                        log
                        <span class="small-text">10</span>
                    </button>
                    
                    <button class="number" onclick="appendToInput('0')">0</button>
                    <button class="number" onclick="appendToInput('.')">.</button>
                    <button class="operator" onclick="appendToInput('+')">+</button>
                    <button class="function" onclick="appendToInput('Math.log(')">
                        ln
                        <span class="small-text">e</span>
                    </button>
                    <button class="equals" onclick="calculate()">=</button>
                </div>
                
                <div class="advanced-buttons hidden" id="advanced-buttons">
                    <button class="constant" onclick="appendToInput('Math.PI')">
                        π
                        <span class="small-text">3.1415</span>
                    </button>
                    <button class="constant" onclick="appendToInput('Math.E')">
                        e
                        <span class="small-text">2.7183</span>
                    </button>
                    <button class="symbol" onclick="appendToInput('^')">
                        ^
                        <span class="small-text">pow</span>
                    </button>
                    
                    <button class="function" onclick="appendToInput('Math.sin(')">sin</button>
                    <button class="function" onclick="appendToInput('Math.cos(')">cos</button>
                    <button class="function" onclick="appendToInput('Math.tan(')">tan</button>
                    
                    <button class="function" onclick="appendToInput('Math.asin(')">sin⁻¹</button>
                    <button class="function" onclick="appendToInput('Math.acos(')">cos⁻¹</button>
                    <button class="function" onclick="appendToInput('Math.atan(')">tan⁻¹</button>
                    
                    <button class="function" onclick="appendToInput('Math.abs(')">abs</button>
                    <button class="function" onclick="appendToInput('Math.floor(')">floor</button>
                    <button class="function" onclick="appendToInput('Math.ceil(')">ceil</button>
                    
                    <button class="function" onclick="appendToInput('Math.round(')">round</button>
                    <button class="function" onclick="appendToInput('Math.random()')">rand</button>
                    <button class="function" onclick="appendToInput('Math.sign(')">sign</button>
                    
                    <button class="function" onclick="appendToInput('Math.exp(')">exp</button>
                    <button class="function" onclick="appendToInput('Math.max(')">max</button>
                    <button class="function" onclick="appendToInput('Math.min(')">min</button>
                    
                    <button class="symbol" onclick="appendToInput('!')">n!</button>
                    <button class="symbol" onclick="appendToInput('Math.PI/180*')">deg→rad</button>
                    <button class="symbol" onclick="appendToInput('180/Math.PI*')">rad→deg</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const inputDisplay = document.getElementById('input');
        const resultDisplay = document.getElementById('result');
        const advancedButtons = document.getElementById('advanced-buttons');
        const modeButtons = document.querySelectorAll('.mode-btn');
        
        let currentInput = '';
        let isAdvancedMode = false;
        let lastResult = null;
        
        // 颜色控制函数
        function updateColor(variable, color) {
            document.documentElement.style.setProperty(variable, color);
        }
        
        // 预设主题
        function applyPreset(preset) {
            const presets = {
                default: {
                    '--primary-color': '#4285f4',
                    '--secondary-color': '#34a853',
                    '--danger-color': '#ea4335',
                    '--warning-color': '#fbbc05',
                    '--dark-color': '#202124',
                    '--light-color': '#f8f9fa',
                    '--text-color': '#333',
                    '--display-bg': '#202124',
                    '--display-text': 'white',
                    '--number-btn-bg': 'white',
                    '--number-btn-text': '#333',
                    '--number-btn-border': '#e0e0e0',
                    '--operator-btn-bg': '#fbbc05',
                    '--operator-btn-text': '#202124',
                    '--function-btn-bg': '#4285f4',
                    '--function-btn-text': 'white',
                    '--equals-btn-bg': '#34a853',
                    '--equals-btn-text': 'white',
                    '--clear-btn-bg': '#ea4335',
                    '--clear-btn-text': 'white',
                    '--symbol-btn-bg': '#9b59b6',
                    '--symbol-btn-text': 'white',
                    '--constant-btn-bg': '#00bcd4',
                    '--constant-btn-text': 'white',
                    '--body-bg': 'linear-gradient(135deg, #f6f7f9 0%, #e7e9ee 100%)',
                    '--calculator-bg': 'white',
                    '--advanced-panel-bg': '#f8f9fa'
                },
                dark: {
                    '--primary-color': '#8ab4f8',
                    '--secondary-color': '#81c995',
                    '--danger-color': '#f28b82',
                    '--warning-color': '#fdd663',
                    '--dark-color': '#3c4043',
                    '--light-color': '#5f6368',
                    '--text-color': '#e8eaed',
                    '--display-bg': '#3c4043',
                    '--display-text': '#e8eaed',
                    '--number-btn-bg': '#5f6368',
                    '--number-btn-text': '#e8eaed',
                    '--number-btn-border': '#3c4043',
                    '--operator-btn-bg': '#fdd663',
                    '--operator-btn-text': '#3c4043',
                    '--function-btn-bg': '#8ab4f8',
                    '--function-btn-text': '#202124',
                    '--equals-btn-bg': '#81c995',
                    '--equals-btn-text': '#202124',
                    '--clear-btn-bg': '#f28b82',
                    '--clear-btn-text': '#202124',
                    '--symbol-btn-bg': '#ba68c8',
                    '--symbol-btn-text': '#202124',
                    '--constant-btn-bg': '#4dd0e1',
                    '--constant-btn-text': '#202124',
                    '--body-bg': 'linear-gradient(135deg, #202124 0%, #3c4043 100%)',
                    '--calculator-bg': '#5f6368',
                    '--advanced-panel-bg': '#3c4043'
                },
                light: {
                    '--primary-color': '#1a73e8',
                    '--secondary-color': '#0b8043',
                    '--danger-color': '#d93025',
                    '--warning-color': '#f29900',
                    '--dark-color': '#f1f3f4',
                    '--light-color': '#ffffff',
                    '--text-color': '#3c4043',
                    '--display-bg': '#f1f3f4',
                    '--display-text': '#3c4043',
                    '--number-btn-bg': '#ffffff',
                    '--number-btn-text': '#3c4043',
                    '--number-btn-border': '#dadce0',
                    '--operator-btn-bg': '#f29900',
                    '--operator-btn-text': '#ffffff',
                    '--function-btn-bg': '#1a73e8',
                    '--function-btn-text': '#ffffff',
                    '--equals-btn-bg': '#0b8043',
                    '--equals-btn-text': '#ffffff',
                    '--clear-btn-bg': '#d93025',
                    '--clear-btn-text': '#ffffff',
                    '--symbol-btn-bg': '#673ab7',
                    '--symbol-btn-text': '#ffffff',
                    '--constant-btn-bg': '#00bcd4',
                    '--constant-btn-text': '#ffffff',
                    '--body-bg': 'linear-gradient(135deg, #ffffff 0%, #f1f3f4 100%)',
                    '--calculator-bg': '#ffffff',
                    '--advanced-panel-bg': '#f8f9fa'
                },
                ocean: {
                    '--primary-color': '#1e88e5',
                    '--secondary-color': '#00acc1',
                    '--danger-color': '#e53935',
                    '--warning-color': '#ffb300',
                    '--dark-color': '#0d47a1',
                    '--light-color': '#bbdefb',
                    '--text-color': '#e3f2fd',
                    '--display-bg': '#0d47a1',
                    '--display-text': '#e3f2fd',
                    '--number-btn-bg': '#bbdefb',
                    '--number-btn-text': '#0d47a1',
                    '--number-btn-border': '#90caf9',
                    '--operator-btn-bg': '#ffb300',
                    '--operator-btn-text': '#0d47a1',
                    '--function-btn-bg': '#1e88e5',
                    '--function-btn-text': '#e3f2fd',
                    '--equals-btn-bg': '#00acc1',
                    '--equals-btn-text': '#e3f2fd',
                    '--clear-btn-bg': '#e53935',
                    '--clear-btn-text': '#e3f2fd',
                    '--symbol-btn-bg': '#5e35b1',
                    '--symbol-btn-text': '#e3f2fd',
                    '--constant-btn-bg': '#00897b',
                    '--constant-btn-text': '#e3f2fd',
                    '--body-bg': 'linear-gradient(135deg, #bbdefb 0%, #90caf9 100%)',
                    '--calculator-bg': '#e3f2fd',
                    '--advanced-panel-bg': '#bbdefb'
                },
                forest: {
                    '--primary-color': '#388e3c',
                    '--secondary-color': '#689f38',
                    '--danger-color': '#d32f2f',
                    '--warning-color': '#fbc02d',
                    '--dark-color': '#1b5e20',
                    '--light-color': '#c8e6c9',
                    '--text-color': '#e8f5e9',
                    '--display-bg': '#1b5e20',
                    '--display-text': '#e8f5e9',
                    '--number-btn-bg': '#c8e6c9',
                    '--number-btn-text': '#1b5e20',
                    '--number-btn-border': '#a5d6a7',
                    '--operator-btn-bg': '#fbc02d',
                    '--operator-btn-text': '#1b5e20',
                    '--function-btn-bg': '#388e3c',
                    '--function-btn-text': '#e8f5e9',
                    '--equals-btn-bg': '#689f38',
                    '--equals-btn-text': '#e8f5e9',
                    '--clear-btn-bg': '#d32f2f',
                    '--clear-btn-text': '#e8f5e9',
                    '--symbol-btn-bg': '#5d4037',
                    '--symbol-btn-text': '#e8f5e9',
                    '--constant-btn-bg': '#00796b',
                    '--constant-btn-text': '#e8f5e9',
                    '--body-bg': 'linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%)',
                    '--calculator-bg': '#e8f5e9',
                    '--advanced-panel-bg': '#c8e6c9'
                }
            };
            
            const colors = presets[preset];
            for (const [key, value] of Object.entries(colors)) {
                document.documentElement.style.setProperty(key, value);
                
                // 更新颜色选择器的值
                const inputId = key.replace('--', '').replace(/-/g, '-');
                const input = document.getElementById(inputId);
                if (input) {
                    input.value = value;
                }
            }
        }
        
        function appendToInput(value) {
            // 如果输入是函数，自动添加右括号
            if (value.endsWith('(') && !value.includes(')')) {
                value = value + ')';
            }
            
            // 处理阶乘特殊情况
            if (value === '!') {
                currentInput = `factorial(${currentInput})`;
                updateInputDisplay();
                return;
            }
            
            currentInput += value;
            updateInputDisplay();
        }
        
        function updateInputDisplay() {
            // 美化显示，替换技术性函数名为更友好的形式
            let displayText = currentInput
                .replace(/Math\./g, '')
                .replace(/PI/g, 'π')
                .replace(/E/g, 'e')
                .replace(/\*\*/g, '^')
                .replace(/pow\(/g, '^(')
                .replace(/sqrt\(/g, '√(');
            
            inputDisplay.textContent = displayText;
        }
        
        function clearAll() {
            currentInput = '';
            resultDisplay.textContent = '0';
            updateInputDisplay();
        }
        
        function backspace() {
            currentInput = currentInput.slice(0, -1);
            updateInputDisplay();
        }
        
        function calculate() {
            try {
                // 替换显示用的符号为JavaScript可识别的表达式
                let expression = currentInput
                    .replace(/π/g, 'Math.PI')
                    .replace(/e/g, 'Math.E')
                    .replace(/\^/g, '**')
                    .replace(/%/g, '/100')
                    .replace(/√\(/g, 'Math.sqrt(')
                    .replace(/deg→rad/g, 'Math.PI/180*')
                    .replace(/rad→deg/g, '180/Math.PI*');
                
                // 安全评估表达式
                const result = evaluateExpression(expression);
                lastResult = result;
                resultDisplay.textContent = formatResult(result);
            } catch (error) {
                resultDisplay.textContent = '错误';
                console.error(error);
            }
        }
        
        // 阶乘函数
        function factorial(n) {
            if (n < 0) throw new Error('负数没有阶乘');
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }
        
        // 格式化结果显示
        function formatResult(result) {
            if (typeof result === 'number') {
                // 处理极大或极小的数字使用科学计数法
                if (Math.abs(result) > 1e12 || (Math.abs(result) < 1e-6 && result !== 0)) {
                    return result.toExponential(8).replace(/(\.\d*?[1-9])0+e/, '$1e');
                }
                
                // 如果是整数，不显示小数点
                if (Number.isInteger(result)) {
                    return result.toString();
                }
                
                // 否则显示最多10位小数，但去掉末尾的0
                const formatted = result.toFixed(10).replace(/(\.\d*?[1-9])0+$/, '$1');
                return formatted.endsWith('.') ? formatted.slice(0, -1) : formatted;
            }
            return result;
        }
        
        // 安全评估数学表达式
        function evaluateExpression(expr) {
            // 使用Function构造函数限制访问范围
            try {
                const allowedFunctions = {
                    Math: {
                        sin: Math.sin,
                        cos: Math.cos,
                        tan: Math.tan,
                        asin: Math.asin,
                        acos: Math.acos,
                        atan: Math.atan,
                        sqrt: Math.sqrt,
                        log: Math.log,
                        log10: function(x) { return Math.log(x) / Math.LN10; },
                        pow: Math.pow,
                        abs: Math.abs,
                        floor: Math.floor,
                        ceil: Math.ceil,
                        round: Math.round,
                        random: Math.random,
                        sign: Math.sign,
                        exp: Math.exp,
                        max: Math.max,
                        min: Math.min,
                        PI: Math.PI,
                        E: Math.E
                    },
                    factorial: factorial
                };
                
                // 更安全的评估方式
                const func = new Function('Math', 'factorial', `return ${expr}`);
                return func(allowedFunctions.Math, factorial);
            } catch (e) {
                throw new Error('无效表达式');
            }
        }
        
        // 切换基本/科学计算模式
        function switchMode(mode) {
            isAdvancedMode = mode === 'advanced';
            
            if (isAdvancedMode) {
                advancedButtons.classList.remove('hidden');
                modeButtons[0].classList.remove('active');
                modeButtons[1].classList.add('active');
            } else {
                advancedButtons.classList.add('hidden');
                modeButtons[0].classList.add('active');
                modeButtons[1].classList.remove('active');
            }
        }
        
        // 键盘支持
        document.addEventListener('keydown', function(event) {
            const key = event.key;
            
            if (/[0-9\.\+\-\*\/\(\)]/.test(key)) {
                appendToInput(key);
            } else if (key === 'Enter' || key === '=') {
                calculate();
            } else if (key === 'Backspace') {
                backspace();
            } else if (key === 'Escape') {
                clearAll();
            } else if (key === '%') {
                appendToInput('%');
            } else if (key === '^') {
                appendToInput('^');
            } else if (key === '!') {
                appendToInput('!');
            } else if (key === 'a' && event.ctrlKey) {
                switchMode(isAdvancedMode ? 'basic' : 'advanced');
            } else if (key === 'p' && event.shiftKey) {
                appendToInput('Math.PI');
            } else if (key === 'e' && event.shiftKey) {
                appendToInput('Math.E');
            }
        });
        
        // 初始化
        clearAll();
    </script>
</body>
</html>