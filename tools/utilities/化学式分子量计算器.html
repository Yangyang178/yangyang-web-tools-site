<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>化学式分子量计算器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            animation: backgroundShift 10s ease-in-out infinite alternate;
        }

        @keyframes backgroundShift {
            0% { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
            100% { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            animation: containerFloat 6s ease-in-out infinite alternate;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes containerFloat {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-10px); }
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: headerGlow 8s linear infinite;
        }

        @keyframes headerGlow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 15px;
            font-weight: 300;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: titlePulse 3s ease-in-out infinite alternate;
        }

        @keyframes titlePulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }

        .main-content {
            padding: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .formula-input {
            width: 100%;
            padding: 18px 60px 18px 25px;
            font-size: 1.3em;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Courier New', monospace;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }

        .clear-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            border-radius: 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #666;
            opacity: 0;
            visibility: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .clear-btn:hover {
            background: linear-gradient(145deg, #ff6b6b, #ff5252);
            color: white;
            border-color: #ff6b6b;
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .clear-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .input-container:hover .clear-btn,
        .formula-input:focus + .clear-btn,
        .formula-input:not(:placeholder-shown) + .clear-btn {
            opacity: 1;
            visibility: visible;
        }

        .formula-input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.15), 
                        inset 0 2px 4px rgba(0,0,0,0.06),
                        0 8px 25px rgba(79, 172, 254, 0.1);
            transform: translateY(-2px);
            background: linear-gradient(145deg, #ffffff, #ffffff);
        }

        .formula-input.error {
            border-color: #ff6b6b;
            background: linear-gradient(145deg, #fff5f5, #ffe8e8);
            animation: inputShake 0.5s ease-in-out;
        }

        @keyframes inputShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .examples {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .example-btn {
            display: inline-block;
            margin: 4px 6px 4px 0;
            padding: 8px 12px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .example-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(79, 172, 254, 0.2), transparent);
            transition: left 0.5s;
        }

        .example-btn:hover {
            background: linear-gradient(145deg, #4facfe, #00f2fe);
            color: white;
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
        }

        .example-btn:hover::before {
            left: 100%;
        }

        .example-btn:active {
            transform: translateY(0px);
            box-shadow: 0 2px 4px rgba(79, 172, 254, 0.2);
        }

        .results-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .results-section {
                grid-template-columns: 1fr;
            }
        }

        .result-card {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            padding: 25px;
            border-left: 5px solid #4facfe;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .result-card:hover::before {
            transform: scaleX(1);
        }

        .result-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
            position: relative;
        }

        .molecular-weight {
            font-size: 2.2em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(79, 172, 254, 0.2);
            animation: numberGlow 2s ease-in-out infinite alternate;
        }

        @keyframes numberGlow {
            0% { text-shadow: 0 2px 4px rgba(79, 172, 254, 0.2); }
            100% { text-shadow: 0 4px 8px rgba(79, 172, 254, 0.4); }
        }

        .unit {
            font-size: 0.8em;
            color: #666;
        }

        .composition-list {
            list-style: none;
        }

        .composition-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(233, 236, 239, 0.5);
            transition: all 0.3s ease;
            position: relative;
        }

        .composition-item:last-child {
            border-bottom: none;
        }

        .composition-item:hover {
            background: linear-gradient(90deg, rgba(79, 172, 254, 0.05), transparent);
            padding-left: 10px;
            border-radius: 8px;
        }

        .element-info {
            display: flex;
            align-items: center;
            position: relative;
        }

        .element-symbol {
            font-weight: bold;
            color: #333;
            margin-right: 12px;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            padding: 4px 8px;
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            border-radius: 6px;
            min-width: 35px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .element-count {
            color: #666;
            font-size: 0.95em;
            font-weight: 500;
        }

        .percentage {
            font-weight: bold;
            color: #4facfe;
            font-size: 1.05em;
            padding: 4px 8px;
            background: linear-gradient(145deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
            border-radius: 6px;
            text-shadow: 0 1px 2px rgba(79, 172, 254, 0.2);
        }

        .error-message {
            background: linear-gradient(145deg, #fff5f5, #ffe8e8);
            color: #e53e3e;
            padding: 18px 20px;
            border-radius: 12px;
            border-left: 5px solid #e53e3e;
            margin-top: 20px;
            font-size: 0.95em;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.15);
            animation: errorSlideIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        @keyframes errorSlideIn {
            0% { 
                opacity: 0; 
                transform: translateY(-20px); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .parsed-formula {
            background: linear-gradient(145deg, #f0f8ff, #e6f3ff);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border-left: 5px solid #4facfe;
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.15);
            animation: resultSlideIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        @keyframes resultSlideIn {
            0% { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .parsed-formula h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .parsed-content {
            font-family: 'Courier New', monospace;
            color: #555;
            line-height: 1.6;
            font-size: 0.95em;
            background: rgba(255, 255, 255, 0.7);
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }

        .footer {
            background: linear-gradient(145deg, #f8f9fa, #e9ecef);
            padding: 25px;
            text-align: center;
            color: #666;
            font-size: 0.95em;
            position: relative;
            overflow: hidden;
        }

        .footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
        }

        /* 添加加载动画 */
        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-content {
            animation: fadeInUp 0.8s ease-out;
        }

        .results-section {
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        /* 响应式优化 */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 2.2em;
            }
            
            .formula-input {
                font-size: 1.1em;
                padding: 15px 20px;
            }
            
            .molecular-weight {
                font-size: 1.8em;
            }
            
            .example-btn {
                font-size: 0.8em;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>化学式分子量计算器</h1>
            <p>输入化学式，实时计算分子量和元素组成</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <div class="input-group">
                    <label for="formula">化学式</label>
                    <div class="input-container">
                        <input type="text" id="formula" class="formula-input" placeholder="例如：H2SO4, Ca(OH)2, CuSO4·5H2O" autocomplete="off">
                        <button type="button" id="clearBtn" class="clear-btn" title="清除输入">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="examples">
                        <strong>示例：</strong>
                        <span class="example-btn" onclick="setFormula('H2SO4')">H2SO4</span>
                        <span class="example-btn" onclick="setFormula('Ca(OH)2')">Ca(OH)2</span>
                        <span class="example-btn" onclick="setFormula('CuSO4·5H2O')">CuSO4·5H2O</span>
                        <span class="example-btn" onclick="setFormula('Al2(SO4)3·18H2O')">Al2(SO4)3·18H2O</span>
                        <span class="example-btn" onclick="setFormula('C6H12O6')">C6H12O6</span>
                        <span class="example-btn" onclick="setFormula('NaCl')">NaCl</span>
                        <span class="example-btn" onclick="setFormula('Ca3(PO4)2')">Ca3(PO4)2</span>
                        <span class="example-btn" onclick="setFormula('Mg(NO3)2·6H2O')">Mg(NO3)2·6H2O</span>
                        <span class="example-btn" onclick="setFormula('K4[Fe(CN)6]·3H2O')">K4[Fe(CN)6]·3H2O</span>
                        <span class="example-btn" onclick="setFormula('(NH4)2SO4')">（NH4)2SO4</span>
                    </div>
                </div>
            </div>

            <div class="results-section">
                <div class="result-card">
                    <h3>分子量</h3>
                    <div class="molecular-weight" id="molecularWeight">-</div>
                    <div class="unit">g/mol</div>
                </div>

                <div class="result-card">
                    <h3>元素组成</h3>
                    <ul class="composition-list" id="compositionList">
                        <li style="color: #999; text-align: center; padding: 20px;">请输入化学式</li>
                    </ul>
                </div>
            </div>

            <div id="errorMessage"></div>
            <div id="parsedFormula"></div>
        </div>

        <div class="footer">
            <p>支持括号、方括号、上下标、结晶水（用·表示）等常见化学式格式</p>
        </div>
    </div>

    <script>
        // 元素周期表数据（原子量）
        const ELEMENTS = {
            'H': 1.008, 'He': 4.003, 'Li': 6.941, 'Be': 9.012, 'B': 10.811, 'C': 12.011, 'N': 14.007, 'O': 15.999,
            'F': 18.998, 'Ne': 20.180, 'Na': 22.990, 'Mg': 24.305, 'Al': 26.982, 'Si': 28.086, 'P': 30.974, 'S': 32.065,
            'Cl': 35.453, 'Ar': 39.948, 'K': 39.098, 'Ca': 40.078, 'Sc': 44.956, 'Ti': 47.867, 'V': 50.942, 'Cr': 51.996,
            'Mn': 54.938, 'Fe': 55.845, 'Co': 58.933, 'Ni': 58.693, 'Cu': 63.546, 'Zn': 65.38, 'Ga': 69.723, 'Ge': 72.64,
            'As': 74.922, 'Se': 78.96, 'Br': 79.904, 'Kr': 83.798, 'Rb': 85.468, 'Sr': 87.62, 'Y': 88.906, 'Zr': 91.224,
            'Nb': 92.906, 'Mo': 95.96, 'Tc': 98, 'Ru': 101.07, 'Rh': 102.906, 'Pd': 106.42, 'Ag': 107.868, 'Cd': 112.411,
            'In': 114.818, 'Sn': 118.71, 'Sb': 121.76, 'Te': 127.6, 'I': 126.904, 'Xe': 131.293, 'Cs': 132.905, 'Ba': 137.327,
            'La': 138.905, 'Ce': 140.116, 'Pr': 140.908, 'Nd': 144.242, 'Pm': 145, 'Sm': 150.36, 'Eu': 151.964, 'Gd': 157.25,
            'Tb': 158.925, 'Dy': 162.5, 'Ho': 164.93, 'Er': 167.259, 'Tm': 168.934, 'Yb': 173.054, 'Lu': 174.967, 'Hf': 178.49,
            'Ta': 180.948, 'W': 183.84, 'Re': 186.207, 'Os': 190.23, 'Ir': 192.217, 'Pt': 195.084, 'Au': 196.967, 'Hg': 200.59,
            'Tl': 204.383, 'Pb': 207.2, 'Bi': 208.98, 'Po': 209, 'At': 210, 'Rn': 222, 'Fr': 223, 'Ra': 226, 'Ac': 227,
            'Th': 232.038, 'Pa': 231.036, 'U': 238.029, 'Np': 237, 'Pu': 244, 'Am': 243, 'Cm': 247, 'Bk': 247, 'Cf': 251,
            'Es': 252, 'Fm': 257, 'Md': 258, 'No': 259, 'Lr': 262, 'Rf': 267, 'Db': 268, 'Sg': 271, 'Bh': 272, 'Hs': 270,
            'Mt': 276, 'Ds': 281, 'Rg': 280, 'Cn': 285, 'Nh': 284, 'Fl': 289, 'Mc': 288, 'Lv': 293, 'Ts': 294, 'Og': 294
        };

        class ChemicalFormulaParser {
            constructor() {
                this.reset();
            }

            reset() {
                this.elements = {};
                this.position = 0;
                this.formula = '';
            }

            parse(formula) {
                this.reset();
                
                try {
                    this.formula = this.preprocessFormula(formula);
                    
                    if (!this.formula) {
                        throw new Error('化学式不能为空');
                    }
                    
                    // 使用栈来处理嵌套结构
                    const result = this.parseWithStack();
                    
                    return { 
                        elements: result, 
                        error: null,
                        processedFormula: this.formula,
                        originalFormula: formula
                    };
                } catch (e) {
                    return { 
                        elements: {}, 
                        error: e.message,
                        processedFormula: this.formula,
                        originalFormula: formula,
                        errorPosition: this.position
                    };
                }
            }

            preprocessFormula(formula) {
                // 移除所有空格
                formula = formula.replace(/\s+/g, '');
                
                // 处理上下标数字
                formula = this.normalizeSubscripts(formula);
                
                // 处理各种括号类型 - 统一转换为圆括号
                formula = formula.replace(/[\[\{]/g, '(');
                formula = formula.replace(/[\]\}]/g, ')');
                formula = formula.replace(/[（]/g, '(');
                formula = formula.replace(/[）]/g, ')');
                
                return formula;
            }

            normalizeSubscripts(formula) {
                const subscriptMap = {
                    '₀': '0', '₁': '1', '₂': '2', '₃': '3', '₄': '4', '₅': '5', '₆': '6', '₇': '7', '₈': '8', '₉': '9',
                    '⁰': '0', '¹': '1', '²': '2', '³': '3', '⁴': '4', '⁵': '5', '⁶': '6', '⁷': '7', '⁸': '8', '⁹': '9'
                };
                
                for (let [sub, normal] of Object.entries(subscriptMap)) {
                    formula = formula.replace(new RegExp(sub, 'g'), normal);
                }
                
                return formula;
            }

            parseWithStack() {
                const stack = [{}]; // 栈，每个元素是一个元素计数对象
                let i = 0;
                
                while (i < this.formula.length) {
                    const char = this.formula[i];
                    
                    if (char === '(') {
                        // 开始新的组
                        stack.push({});
                        i++;
                    } else if (char === ')') {
                        // 结束当前组
                        if (stack.length <= 1) {
                            throw new Error(`意外的右括号 (位置 ${i + 1})`);
                        }
                        
                        const group = stack.pop();
                        i++;
                        
                        // 解析括号后的数字
                        let numStr = '';
                        while (i < this.formula.length && /\d/.test(this.formula[i])) {
                            numStr += this.formula[i++];
                        }
                        const multiplier = numStr ? parseInt(numStr) : 1;
                        
                        // 将组中的元素乘以倍数后加入上一层
                        const parent = stack[stack.length - 1];
                        for (const [element, count] of Object.entries(group)) {
                            parent[element] = (parent[element] || 0) + count * multiplier;
                        }
                    } else if (/[·•⋅.]/.test(char)) {
                        // 遇到结晶水分隔符，跳过并继续解析
                        i++;
                        // 继续解析后面的内容，不做特殊处理
                    } else if (/[A-Z]/.test(char)) {
                        // 解析元素
                        let element = char;
                        i++;
                        
                        // 检查小写字母
                        while (i < this.formula.length && /[a-z]/.test(this.formula[i])) {
                            element += this.formula[i++];
                        }
                        
                        // 验证元素
                        if (!ELEMENTS[element]) {
                            throw new Error(`未知元素: ${element}`);
                        }
                        
                        // 解析数字
                        let numStr = '';
                        while (i < this.formula.length && /\d/.test(this.formula[i])) {
                            numStr += this.formula[i++];
                        }
                        const count = numStr ? parseInt(numStr) : 1;
                        
                        // 添加到当前层
                        const current = stack[stack.length - 1];
                        current[element] = (current[element] || 0) + count;
                    } else if (/\d/.test(char)) {
                        // 如果遇到数字，检查前面是否有结晶水分隔符
                        // 这种情况下，数字应该是结晶水分子的系数
                        let j = i - 1;
                        while (j >= 0 && /\s/.test(this.formula[j])) j--; // 跳过空格
                        
                        if (j >= 0 && /[·•⋅.]/.test(this.formula[j])) {
                            // 前面有结晶水分隔符，这个数字是水分子的系数
                            // 解析完整的数字
                            let numStr = '';
                            while (i < this.formula.length && /\d/.test(this.formula[i])) {
                                numStr += this.formula[i++];
                            }
                            const waterCount = parseInt(numStr);
                            
                            // 检查后面是否跟着H2O
                            if (i + 2 < this.formula.length && 
                                this.formula.substring(i, i + 3) === 'H2O') {
                                // 添加水分子
                                const current = stack[stack.length - 1];
                                current['H'] = (current['H'] || 0) + waterCount * 2;
                                current['O'] = (current['O'] || 0) + waterCount * 1;
                                i += 3; // 跳过H2O
                            } else {
                                throw new Error(`结晶水格式错误: 期望H2O，但找到 ${this.formula.substring(i, i + 3)} (位置 ${i + 1})`);
                            }
                        } else {
                            throw new Error(`意外的数字: ${char} (位置 ${i + 1})`);
                        }
                    } else {
                        throw new Error(`无效字符: ${char} (位置 ${i + 1})`);
                    }
                }
                
                if (stack.length !== 1) {
                    throw new Error('括号不匹配：缺少右括号');
                }
                
                return stack[0];
            }
        }

        class MolecularWeightCalculator {
            constructor() {
                this.parser = new ChemicalFormulaParser();
            }

            calculate(formula) {
                const result = this.parser.parse(formula);
                
                if (result.error) {
                    return { 
                        error: result.error,
                        processedFormula: result.processedFormula,
                        originalFormula: result.originalFormula,
                        errorPosition: result.errorPosition
                    };
                }

                let totalWeight = 0;
                const composition = [];

                for (const [element, count] of Object.entries(result.elements)) {
                    const atomicWeight = ELEMENTS[element];
                    const elementWeight = atomicWeight * count;
                    totalWeight += elementWeight;
                    
                    composition.push({
                        element,
                        count,
                        atomicWeight,
                        totalWeight: elementWeight
                    });
                }

                // 计算百分比
                composition.forEach(item => {
                    item.percentage = (item.totalWeight / totalWeight * 100).toFixed(2);
                });

                // 按元素符号排序
                composition.sort((a, b) => a.element.localeCompare(b.element));

                return {
                    molecularWeight: totalWeight.toFixed(3),
                    composition,
                    elements: result.elements,
                    processedFormula: result.processedFormula,
                    originalFormula: result.originalFormula
                };
            }
        }

        // 初始化计算器
        const calculator = new MolecularWeightCalculator();
        const formulaInput = document.getElementById('formula');
        const molecularWeightDiv = document.getElementById('molecularWeight');
        const compositionList = document.getElementById('compositionList');
        const errorMessageDiv = document.getElementById('errorMessage');
        const parsedFormulaDiv = document.getElementById('parsedFormula');

        function updateResults() {
            const formula = formulaInput.value.trim();
            
            // 清除之前的错误状态
            formulaInput.classList.remove('error');
            errorMessageDiv.innerHTML = '';
            parsedFormulaDiv.innerHTML = '';
            
            if (!formula) {
                molecularWeightDiv.textContent = '-';
                compositionList.innerHTML = '<li style="color: #999; text-align: center; padding: 20px;">请输入化学式</li>';
                return;
            }

            const result = calculator.calculate(formula);

            if (result.error) {
                formulaInput.classList.add('error');
                molecularWeightDiv.textContent = '-';
                compositionList.innerHTML = '<li style="color: #999; text-align: center; padding: 20px;">解析失败</li>';
                
                let errorMsg = `错误: ${result.error}`;
                if (result.processedFormula && result.processedFormula !== result.originalFormula) {
                    errorMsg += `<br><small>处理后的化学式: ${result.processedFormula}</small>`;
                }
                
                errorMessageDiv.innerHTML = `<div class="error-message">${errorMsg}</div>`;
                return;
            }

            // 显示分子量
            molecularWeightDiv.textContent = result.molecularWeight;

            // 显示元素组成
            compositionList.innerHTML = '';
            result.composition.forEach(item => {
                const li = document.createElement('li');
                li.className = 'composition-item';
                li.innerHTML = `
                    <div class="element-info">
                        <span class="element-symbol">${item.element}</span>
                        <span class="element-count">× ${item.count}</span>
                    </div>
                    <span class="percentage">${item.percentage}%</span>
                `;
                compositionList.appendChild(li);
            });

            // 显示解析结果
            const elementsStr = Object.entries(result.elements)
                .map(([element, count]) => `${element}: ${count}`)
                .join(', ');
            
            let parsedContent = `<div class="parsed-formula">
                <h4>解析结果</h4>
                <div class="parsed-content">${elementsStr}</div>`;
            
            if (result.processedFormula !== result.originalFormula) {
                parsedContent += `<div class="parsed-content" style="margin-top: 8px; color: #888;">
                    处理后: ${result.processedFormula}
                </div>`;
            }
            
            parsedContent += `</div>`;
            parsedFormulaDiv.innerHTML = parsedContent;
        }

        function setFormula(formula) {
            formulaInput.value = formula;
            updateResults();
        }

        function clearFormula() {
            formulaInput.value = '';
            formulaInput.focus();
            updateResults();
            
            // 添加清除动画效果
            formulaInput.style.transform = 'scale(0.98)';
            setTimeout(() => {
                formulaInput.style.transform = 'scale(1)';
            }, 150);
        }

        // 绑定事件
        const clearBtn = document.getElementById('clearBtn');
        
        formulaInput.addEventListener('input', updateResults);
        formulaInput.addEventListener('paste', () => {
            setTimeout(updateResults, 10);
        });
        
        clearBtn.addEventListener('click', clearFormula);
        
        // 键盘快捷键支持 (Ctrl+Delete 或 Escape)
        formulaInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey && e.key === 'Delete') || e.key === 'Escape') {
                e.preventDefault();
                clearFormula();
            }
        });

        // 初始化
        updateResults();
    </script>
</body>
</html>
